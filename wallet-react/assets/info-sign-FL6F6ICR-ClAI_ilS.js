const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index.browser.esm-DPEcu6bb.js","./index-DRbKv4Ap.js","./index-WnVwkxgD.css"])))=>i.map(i=>d[i]);
import{J as re,L as le,a0 as ie,H as oe,l as ce,r as m,a1 as o,N as k,P as U,a2 as me,a3 as i,a4 as q,a5 as h,a6 as de,Z as ue,o as a,a7 as ge,a8 as ve,B as z,a9 as b,aa as I,ab as P,ac as pe,ad as fe}from"./index-DRbKv4Ap.js";import{V as Ee,L as he,n as ye,b as Ne,D as _e,T as we}from"./index-Dm8n8_bb.js";import{C as Ce}from"./chunk-ZSOFK2U2-Dv4-jFsK.js";import{N as Se}from"./chunk-BOXSB6AN-BNzyKhvg.js";import{N as Te}from"./chunk-6X7TBCV3-Dsqvp6wN.js";import{u as Ae}from"./useTranslation-DS9VROIZ.js";import"./colors-kmmWkomu.js";import"./chunk-3WXPHVZ4-BetGuJbx.js";import"./isObject-CrIk3fyR.js";import"./index-CdvU58q-.js";var ke="ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL",be={async findAssociatedTokenAddress(y,r){let{PublicKey:l}=await pe(()=>import("./index.browser.esm-DPEcu6bb.js"),__vite__mapDeps([0,1,2]),import.meta.url),N=new l("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");return l.findProgramAddressSync([new l(y).toBuffer(),N.toBuffer(),new l(r).toBuffer()],new l(ke))[0]}},K=be;function Ie(y){let{method:r,param:l,chainId:N,loginAuthorizationSign:M}=y,{t}=Ae(),_=re(),{setPaymentVerify:V,userInfo:d,setPaymentPassword:D}=le(),{events:w}=ie(),{modalOptions:L}=oe(),{authCoreModal:W}=ce(),{errorHandle:H}=Ce(),[R,C]=m.useState(!1),B=Se(),[u,J]=m.useState(),[O,Z]=m.useState(),[$,Q]=m.useState(),[j,p]=m.useState(""),[X,f]=m.useState(""),{hasSetPaymentPassword:S,showSetPaymentPasswordOrConfirm:Y}=Ee(),g=m.useMemo(()=>({id:N||o.solana.chainId,name:"Solana"}),[]),ee=m.useMemo(()=>{let s=o.solana.selectedAddress;return k(s)},[]);m.useEffect(()=>{U().catch(s=>{}),me()&&_("account/master-password/verify")},[_]);let ae=()=>{U().then(()=>{F()}).catch(s=>{var e;C(!1),B.error((e=s.message)!=null?e:"Sign Error")})},G=(s,e)=>{w.emit("signResponse",{result:s,error:e})};async function x(s,e){if(!e)return[];let n=await Promise.all(e.map(s));return e.filter((v,c)=>n[c])}let F=async()=>{var s,e;!r||(b({record_type:I.PAGE_SIGN_CONFIRM_BUTTON_CLICK}),(s=d==null?void 0:d.security_account)!=null&&s.has_set_payment_password?V({visible:!0,onVerifyCompleted:T}):r===i.signAndSendTransaction||r===i.signTransaction||r===i.signAllTransactions||((e=L==null?void 0:L.promptSettingConfig)==null?void 0:e.promptPaymentPasswordSettingWhenSign)===3?Y(T):T())},T=async()=>{var s;if(!r)return;C(!0);let e;try{if(r===i.signMessage){let{signature:n}=await o.solana.signMessage(l);e=n}else if(r===i.signAndSendTransaction){let{signature:n}=await o.solana.signAndSendTransaction(l,g.id);e=n}else if(r===i.signTransaction)e=await o.solana.signTransaction(l,g.id);else if(r===i.signAllTransactions)e=await o.solana.signAllTransactions(l,g.id);else throw new Error("Unknown method");b({record_type:I.PAGE_SIGN_CONFIRM_BUTTON_CLICK_SUCCESS})}catch(n){b({record_type:I.PAGE_SIGN_CONFIRM_BUTTON_CLICK_FAILURE}),(n==null?void 0:n.error_code)===50103&&!((s=d==null?void 0:d.security_account)!=null&&s.has_set_payment_password)?ae():(n==null?void 0:n.message)==="Local Key not found"||(n==null?void 0:n.message)==="Master password decryption error"?_("account/master-password/verify"):H(n)}finally{C(!1)}e&&(r===i.signMessage&&M?w.emit("loginSuccess",{...d,authorization:{message:h.encode(l),signature:e}}):G(e))},ne=()=>{R||(M?w.emit("loginSuccess",d):G(void 0,fe.userRejectedRequest()))};m.useEffect(()=>{if(r===i.signMessage)p(t("sign.signature_message")),f(t("sign.signature_title"));else if(r===i.signAndSendTransaction){p(t("sign.send_transaction")),f(t("sign.approve_and").format(q(g)));let s=l.serialize({requireAllSignatures:!1,verifySignatures:!1});E([h.encode(s)])}else if(r===i.signTransaction){p(t("sign.sign_transaction")),f(t("sign.sign_but"));let s=l.serialize({requireAllSignatures:!1,verifySignatures:!1});E([h.encode(s)])}else if(r===i.signAllTransactions){p(t("sign.sign_transaction")),f(t("sign.sign_but"));let s=l.map(e=>h.encode(e.serialize({requireAllSignatures:!1,verifySignatures:!1})));E(s)}else throw new Error("Unknown method")},[l]),m.useEffect(()=>{o.solana.connect()},[]);let E=s=>{o.solana.request({chainId:g.id,method:de.enhancedDeserializeTransaction,params:s}).then(e=>{var n,v;J(e),x(async c=>{let A=await K.findAssociatedTokenAddress(o.solana.selectedAddress,c.mint);return c.associatedTokenAddress===A.toBase58()},(n=e==null?void 0:e.estimatedChanges)==null?void 0:n.nfts).then(c=>{Z(c)}),x(async c=>{let A=await K.findAssociatedTokenAddress(o.solana.selectedAddress,c.mint);return c.associatedTokenAddress===A.toBase58()},(v=e==null?void 0:e.estimatedChanges)==null?void 0:v.tokens).then(c=>{Q(c)})}).catch(e=>{var n;ue.error({title:(n=e.message)!=null?n:"Deserialize Transaction Error",okCancel:!0,cancelText:t("common.cancel"),okText:t("common.retry"),wrapClassName:"auth-core-modal-error",getContainer:()=>W.rootBody,onOk:()=>{E(s)}})})},se=()=>{let s=new TextDecoder().decode(l);return a.createElement("div",{className:"sign-message"},a.createElement("div",{className:"message"+(S?"":" no-password-tip")},a.createElement("div",{className:"pre-wrap personal-message"},s)))},te=()=>{var s;return a.createElement(we,{defaultActiveKey:"1",items:[{label:t("sign.details"),key:"1",children:a.createElement(a.Fragment,null,a.createElement("div",{className:"balance-change"},a.createElement("div",{className:"title"},t("sign.estimated_balance_change")),a.createElement("div",{className:"change-body"},(s=u==null?void 0:u.estimatedChanges)==null?void 0:s.sols.filter(e=>{var n,v;return e.address===((v=(n=o)==null?void 0:n.solana)==null?void 0:v.selectedAddress)}).map((e,n)=>a.createElement("div",{className:"change-title",key:`sol-change-${n}`},"SOL",a.createElement("div",{className:"change-val",style:e.lamportsChange<0?{color:"#ea4335"}:{}},e.lamportsChange<0?"":"+",P(e.lamportsChange,9)))),O==null?void 0:O.map((e,n)=>a.createElement("div",{className:"change-title",key:`nft-change-${n}`},e.name?e.name:"Unknown NFT",a.createElement("div",{className:"change-val",style:e.amountChange<0?{color:"#ea4335"}:{}},e.amountChange<0?"":"+",e.amountChange))),$==null?void 0:$.map((e,n)=>a.createElement("div",{className:"change-title",key:`token-change-${n}`},e.name?e.name:"Unknown Token",a.createElement("div",{className:"change-val",style:e.amountChange<0?{color:"#ea4335"}:{}},e.amountChange<0?"":"+",P(e.amountChange,e.decimals)))))),a.createElement("div",{className:"net-fee solana"},a.createElement("div",{className:"title"},t("sign.network_fee"),u&&a.createElement("div",{className:"fee-val"},P(u.estimatedLamportsFee,9)," SOL"))))},{label:t("sign.data"),key:"2",children:a.createElement("div",null,u==null?void 0:u.instructions.map((e,n)=>a.createElement("div",{className:"inner-instruction",key:`instruction-${n}`},a.createElement("div",{className:"inner-content"},a.createElement("div",{className:"content-item"},a.createElement("div",{className:"item"},a.createElement("div",{className:"item-0"},"#",n+1," - ",t(`program.${e.type}`)),a.createElement("div",{className:"item-1 mt10"},t("sign.program_id"),a.createElement("span",null,k(e.programId))),a.createElement("div",{className:"item-1 mt15"},t("sign.data"),a.createElement("span",null,k(e.data)))))))))}]})};return a.createElement("div",{className:"info-sign"},a.createElement("style",null,he),!S&&a.createElement("div",{className:"has-payment-password","data-telegram":ge()},a.createElement("div",{className:"has-payment-password-icon"}),a.createElement("div",{className:"has-payment-password-tip"},t("account.waring_tip1")),a.createElement("div",{className:"has-payment-password-set",onClick:D},t("account.set"))),a.createElement("div",{className:"scroll-part"+(S?"":" no-password-tip")},a.createElement(ye,{userInfo:d,transactionInfo:u}),a.createElement("div",{className:"info-request"},j),a.createElement("div",{className:"info-title"},a.createElement("img",{src:ve(g),alt:""}),q(g)),a.createElement(Ne,{text:o.solana.selectedAddress,onCopy:()=>B.success(t("new.copied_to"))},a.createElement("div",{className:"info-address"},ee,a.createElement("div",{className:"copy-icon"},a.createElement(_e,null)))),a.createElement("div",{className:"info-des"},X),a.createElement("div",{className:"apart-line"}),r===i.signMessage&&se(),r!==i.signMessage&&te()),a.createElement("div",{className:"btn-box"},a.createElement("div",null,a.createElement(z,{className:"btn-cancel",onClick:ne},t("common.cancel")),a.createElement(z,{className:"btn-approve",onClick:F,loading:R},t("common.confirm"))),a.createElement(Te,null)))}var Ue=Ie;export{Ue as default};
