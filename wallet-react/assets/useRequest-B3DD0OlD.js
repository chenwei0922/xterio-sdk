import{r as h,aR as g,aS as b,bF as J,bG as y,aT as M,bH as B,bI as K,bJ as Q,bK as $,bL as V,aQ as q}from"./index-DRbKv4Ap.js";import{u as x}from"./index-Di3Du_nH.js";import{a as X}from"./debounce-DcEcXjGl.js";import{B as Y}from"./throttle-B_QCviSc.js";import{u as T}from"./index-YRmSynDC.js";var U=function(e,r){var n=r.manual,t=r.ready,i=t===void 0?!0:t,a=r.defaultParams,o=a===void 0?[]:a,d=r.refreshDeps,s=d===void 0?[]:d,f=r.refreshDepsAction,v=h.useRef(!1);return v.current=!1,x(function(){!n&&i&&(v.current=!0,e.run.apply(e,g([],b(o),!1)))},[i]),x(function(){v.current||n||(v.current=!0,f?f():e.refresh())},g([],b(s),!1)),{onBefore:function(){if(!i)return{stopNow:!0}}}};U.onInit=function(e){var r=e.ready,n=r===void 0?!0:r,t=e.manual;return{loading:!t&&n}};function G(e,r){var n=h.useRef({deps:r,obj:void 0,initialized:!1}).current;return(n.initialized===!1||!J(n.deps,r))&&(n.deps=r,n.obj=e(),n.initialized=!0),n.obj}var D=new Map,Z=function(e,r,n){var t=D.get(e);t!=null&&t.timer&&clearTimeout(t.timer);var i=void 0;r>-1&&(i=setTimeout(function(){D.delete(e)},r)),D.set(e,y(y({},n),{timer:i}))},I=function(e){return D.get(e)},F=new Map,k=function(e){return F.get(e)},ee=function(e,r){F.set(e,r),r.then(function(n){return F.delete(e),n}).catch(function(){F.delete(e)})},w={},ne=function(e,r){w[e]&&w[e].forEach(function(n){return n(r)})},W=function(e,r){return w[e]||(w[e]=[]),w[e].push(r),function(){var t=w[e].indexOf(r);w[e].splice(t,1)}},re=function(e,r){var n=r.cacheKey,t=r.cacheTime,i=t===void 0?5*60*1e3:t,a=r.staleTime,o=a===void 0?0:a,d=r.setCache,s=r.getCache,f=h.useRef(),v=h.useRef(),u=function(c,l){d?d(l):Z(c,i,l),ne(c,l.data)},m=function(c,l){return l===void 0&&(l=[]),s?s(l):I(c)};return G(function(){if(n){var c=m(n);c&&Object.hasOwnProperty.call(c,"data")&&(e.state.data=c.data,e.state.params=c.params,(o===-1||new Date().getTime()-c.time<=o)&&(e.state.loading=!1)),f.current=W(n,function(l){e.setState({data:l})})}},[]),M(function(){var c;(c=f.current)===null||c===void 0||c.call(f)}),n?{onBefore:function(c){var l=m(n,c);return!l||!Object.hasOwnProperty.call(l,"data")?{}:o===-1||new Date().getTime()-l.time<=o?{loading:!1,data:l==null?void 0:l.data,error:void 0,returnNow:!0}:{data:l==null?void 0:l.data,error:void 0}},onRequest:function(c,l){var p=k(n);return p&&p!==v.current?{servicePromise:p}:(p=c.apply(void 0,g([],b(l),!1)),v.current=p,ee(n,p),{servicePromise:p})},onSuccess:function(c,l){var p;n&&((p=f.current)===null||p===void 0||p.call(f),u(n,{data:c,params:l,time:new Date().getTime()}),f.current=W(n,function(E){e.setState({data:E})}))},onMutate:function(c){var l;n&&((l=f.current)===null||l===void 0||l.call(f),u(n,{data:c,params:e.state.params,time:new Date().getTime()}),f.current=W(n,function(p){e.setState({data:p})}))}}:{}},te=function(e,r){var n=r.debounceWait,t=r.debounceLeading,i=r.debounceTrailing,a=r.debounceMaxWait,o=h.useRef(),d=h.useMemo(function(){var s={};return t!==void 0&&(s.leading=t),i!==void 0&&(s.trailing=i),a!==void 0&&(s.maxWait=a),s},[t,i,a]);return h.useEffect(function(){if(n){var s=e.runAsync.bind(e);return o.current=X(function(f){f()},n,d),e.runAsync=function(){for(var f=[],v=0;v<arguments.length;v++)f[v]=arguments[v];return new Promise(function(u,m){var c;(c=o.current)===null||c===void 0||c.call(o,function(){s.apply(void 0,g([],b(f),!1)).then(u).catch(m)})})},function(){var f;(f=o.current)===null||f===void 0||f.cancel(),e.runAsync=s}}},[n,d]),n?{onCancel:function(){var s;(s=o.current)===null||s===void 0||s.cancel()}}:{}},ie=function(e,r){var n=r.loadingDelay,t=r.ready,i=h.useRef();if(!n)return{};var a=function(){i.current&&clearTimeout(i.current)};return{onBefore:function(){return a(),t!==!1&&(i.current=setTimeout(function(){e.setState({loading:!0})},n)),{loading:!1}},onFinally:function(){a()},onCancel:function(){a()}}};function j(){return B?document.visibilityState!=="hidden":!0}var S=[];function ue(e){return S.push(e),function(){var n=S.indexOf(e);S.splice(n,1)}}if(B){var ae=function(){if(j())for(var e=0;e<S.length;e++){var r=S[e];r()}};window.addEventListener("visibilitychange",ae,!1)}var oe=function(e,r){var n=r.pollingInterval,t=r.pollingWhenHidden,i=t===void 0?!0:t,a=r.pollingErrorRetryCount,o=a===void 0?-1:a,d=h.useRef(),s=h.useRef(),f=h.useRef(0),v=function(){var u;d.current&&clearTimeout(d.current),(u=s.current)===null||u===void 0||u.call(s)};return x(function(){n||v()},[n]),n?{onBefore:function(){v()},onError:function(){f.current+=1},onSuccess:function(){f.current=0},onFinally:function(){o===-1||o!==-1&&f.current<=o?d.current=setTimeout(function(){!i&&!j()?s.current=ue(function(){e.refresh()}):e.refresh()},n):f.current=0},onCancel:function(){v()}}:{}};function se(e,r){var n=!1;return function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];n||(n=!0,e.apply(void 0,g([],b(t),!1)),setTimeout(function(){n=!1},r))}}function ce(){return B&&typeof navigator.onLine<"u"?navigator.onLine:!0}var A=[];function fe(e){return A.push(e),function(){var n=A.indexOf(e);n>-1&&A.splice(n,1)}}if(B){var z=function(){if(!(!j()||!ce()))for(var e=0;e<A.length;e++){var r=A[e];r()}};window.addEventListener("visibilitychange",z,!1),window.addEventListener("focus",z,!1)}var le=function(e,r){var n=r.refreshOnWindowFocus,t=r.focusTimespan,i=t===void 0?5e3:t,a=h.useRef(),o=function(){var d;(d=a.current)===null||d===void 0||d.call(a)};return h.useEffect(function(){if(n){var d=se(e.refresh.bind(e),i);a.current=fe(function(){d()})}return function(){o()}},[n,i]),M(function(){o()}),{}},de=function(e,r){var n=r.retryInterval,t=r.retryCount,i=h.useRef(),a=h.useRef(0),o=h.useRef(!1);return t?{onBefore:function(){o.current||(a.current=0),o.current=!1,i.current&&clearTimeout(i.current)},onSuccess:function(){a.current=0},onError:function(){if(a.current+=1,t===-1||a.current<=t){var d=n??Math.min(1e3*Math.pow(2,a.current),3e4);i.current=setTimeout(function(){o.current=!0,e.refresh()},d)}else a.current=0},onCancel:function(){a.current=0,i.current&&clearTimeout(i.current)}}:{}},ve=function(e,r){var n=r.throttleWait,t=r.throttleLeading,i=r.throttleTrailing,a=h.useRef(),o={};return t!==void 0&&(o.leading=t),i!==void 0&&(o.trailing=i),h.useEffect(function(){if(n){var d=e.runAsync.bind(e);return a.current=Y(function(s){s()},n,o),e.runAsync=function(){for(var s=[],f=0;f<arguments.length;f++)s[f]=arguments[f];return new Promise(function(v,u){var m;(m=a.current)===null||m===void 0||m.call(a,function(){d.apply(void 0,g([],b(s),!1)).then(v).catch(u)})})},function(){var s;e.runAsync=d,(s=a.current)===null||s===void 0||s.cancel()}}},[n,t,i]),n?{onCancel:function(){var d;(d=a.current)===null||d===void 0||d.cancel()}}:{}},he=function(e){h.useEffect(function(){e==null||e()},[])},me=function(){var e=b(h.useState({}),2),r=e[1];return h.useCallback(function(){return r({})},[])},pe=function(){function e(r,n,t,i){i===void 0&&(i={}),this.serviceRef=r,this.options=n,this.subscribe=t,this.initState=i,this.count=0,this.state={loading:!1,params:void 0,data:void 0,error:void 0},this.state=y(y(y({},this.state),{loading:!n.manual}),i)}return e.prototype.setState=function(r){r===void 0&&(r={}),this.state=y(y({},this.state),r),this.subscribe()},e.prototype.runPluginHandler=function(r){for(var n=[],t=1;t<arguments.length;t++)n[t-1]=arguments[t];var i=this.pluginImpls.map(function(a){var o;return(o=a[r])===null||o===void 0?void 0:o.call.apply(o,g([a],b(n),!1))}).filter(Boolean);return Object.assign.apply(Object,g([{}],b(i),!1))},e.prototype.runAsync=function(){for(var r,n,t,i,a,o,d,s,f,v,u=[],m=0;m<arguments.length;m++)u[m]=arguments[m];return K(this,void 0,void 0,function(){var c,l,p,E,H,_,L,O,P,R,N;return Q(this,function(C){switch(C.label){case 0:if(this.count+=1,c=this.count,l=this.runPluginHandler("onBefore",u),p=l.stopNow,E=p===void 0?!1:p,H=l.returnNow,_=H===void 0?!1:H,L=$(l,["stopNow","returnNow"]),E)return[2,new Promise(function(){})];if(this.setState(y({loading:!0,params:u},L)),_)return[2,Promise.resolve(L.data)];(n=(r=this.options).onBefore)===null||n===void 0||n.call(r,u),C.label=1;case 1:return C.trys.push([1,3,,4]),O=this.runPluginHandler("onRequest",this.serviceRef.current,u).servicePromise,O||(O=(N=this.serviceRef).current.apply(N,g([],b(u),!1))),[4,O];case 2:return P=C.sent(),c!==this.count?[2,new Promise(function(){})]:(this.setState({data:P,error:void 0,loading:!1}),(i=(t=this.options).onSuccess)===null||i===void 0||i.call(t,P,u),this.runPluginHandler("onSuccess",P,u),(o=(a=this.options).onFinally)===null||o===void 0||o.call(a,u,P,void 0),c===this.count&&this.runPluginHandler("onFinally",u,P,void 0),[2,P]);case 3:if(R=C.sent(),c!==this.count)return[2,new Promise(function(){})];throw this.setState({error:R,loading:!1}),(s=(d=this.options).onError)===null||s===void 0||s.call(d,R,u),this.runPluginHandler("onError",R,u),(v=(f=this.options).onFinally)===null||v===void 0||v.call(f,u,void 0,R),c===this.count&&this.runPluginHandler("onFinally",u,void 0,R),R;case 4:return[2]}})})},e.prototype.run=function(){for(var r=this,n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];this.runAsync.apply(this,g([],b(n),!1)).catch(function(i){r.options.onError||console.error(i)})},e.prototype.cancel=function(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")},e.prototype.refresh=function(){this.run.apply(this,g([],b(this.state.params||[]),!1))},e.prototype.refreshAsync=function(){return this.runAsync.apply(this,g([],b(this.state.params||[]),!1))},e.prototype.mutate=function(r){var n=V(r)?r(this.state.data):r;this.runPluginHandler("onMutate",n),this.setState({data:n})},e}();function ge(e,r,n){r===void 0&&(r={}),n===void 0&&(n=[]);var t=r.manual,i=t===void 0?!1:t,a=r.ready,o=a===void 0?!0:a,d=$(r,["manual","ready"]),s=y({manual:i,ready:o},d),f=q(e),v=me(),u=G(function(){var m=n.map(function(c){var l;return(l=c==null?void 0:c.onInit)===null||l===void 0?void 0:l.call(c,s)}).filter(Boolean);return new pe(f,s,v,Object.assign.apply(Object,g([{}],b(m),!1)))},[]);return u.options=s,u.pluginImpls=n.map(function(m){return m(u,s)}),he(function(){if(!i&&o){var m=u.state.params||r.defaultParams||[];u.run.apply(u,g([],b(m),!1))}}),M(function(){u.cancel()}),{loading:u.state.loading,data:u.state.data,error:u.state.error,params:u.state.params||[],cancel:T(u.cancel.bind(u)),refresh:T(u.refresh.bind(u)),refreshAsync:T(u.refreshAsync.bind(u)),run:T(u.run.bind(u)),runAsync:T(u.runAsync.bind(u)),mutate:T(u.mutate.bind(u))}}function Te(e,r,n){return ge(e,r,g(g([],b([]),!1),[te,ie,oe,le,ve,U,re,de],!1))}export{Te as u};
